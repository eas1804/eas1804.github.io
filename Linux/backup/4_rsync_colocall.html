<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Backup</title>
    <link rel="stylesheet" href="../../style.css">
  </head>

<body>

# В случае ошибки при выполнении функции высылается сообщение в Telegramm
<pre>
#!/bin/bash

username=backup94807-09
server=backup94807-09.backup.colocall.eu


# Функция1. Не высылать сообщение в случае ошибки синхронизации
box_unac_notest () {
echo --------------------------------
echo  $target_directory
/usr/bin/rsync -zav  --progress -e 'ssh -p22 -i ~/.ssh/colocall.key' --recursive "$local_directory" "$username@$server:$target_directory"
/usr/bin/rsync -zav  --progress --delete -e 'ssh -p22 -i ~/.ssh/colocall.key' --recursive "$local_directory" "$username@$server:$target_directory"
}

# Функция2. Выслать сообщение в случае ошибки синхронизации
box_unac () {
echo --------------------------------
echo  $target_directory
/usr/bin/rsync -zav  --progress -e 'ssh -p22 -i ~/.ssh/colocall.key' --recursive "$local_directory" "$username@$server:$target_directory"
/usr/bin/rsync -zav  --progress --delete -e 'ssh -p22 -i ~/.ssh/colocall.key' --recursive "$local_directory" "$username@$server:$target_directory"
# "Есть ли ошибки -
if [ $? -ne 0 ]; then
MESSAGE="Ошибка выполнения скрипта
$echo $0
LAN ip $IP_local
WAN ip $WAN $IP_global
$local_directory

Remote:
$server
$target_directory
"
curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" -d "chat_id=$CHAT_ID&text=$MESSAGE" > /dev/null
else
    echo "Команда выполнена успешно."
fi
}

#Функция 3. Сравнить количество файлов локаьных и удаленных
count_of_files () {
REMOTE_COUNT=$(ssh -p22 -i ~/.ssh/colocall.key $username@$server find $target_directory | wc -l)
LOCAL_COUNT=$(find  "$local_directory" | wc -l)
echo REMOTE_COUNT $REMOTE_COUNT
echo LOCAL_COUNT $LOCAL_COUNT

if [ "$REMOTE_COUNT" -ne "$LOCAL_COUNT" ]; then
    echo "ошибка"
MESSAGE="Ошибка выполнения скрипта
$echo $0
LAN ip $IP_local
WAN ip $WAN $IP_global
$local_directory

Remote:
$server
$target_directory

Колличество файлов не совпадает!!!
REMOTE_COUNT $REMOTE_COUNT
LOCAL_COUNT  $LOCAL_COUNT
"
curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" -d "chat_id=$CHAT_ID&text=$MESSAGE" > /dev/null
fi
}

########
IP_local=$(ip -4 a | grep inet | grep eth0 |  awk '/inet/ {print $2}')
IP_global=$(curl 2ip.ru)
# telegramm env
BOT_TOKEN="18045447450203:AAGEjU7HKEEGle1Zv2an5sVF49QxNxhw03w"
CHAT_ID="33109821804"



# Drive Z
local_directory=/mnt/drive_z/
target_directory=/backup/Arhive/2_unac/drive_z/
box_unac_notest

# 1c
local_directory=/mnt/1c/
target_directory=/backup/Arhive/2_unac/1c/
box_unac
count_of_files

</pre>



</body>
  </html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>proxmox backup server</title>
    <link rel="stylesheet" href="../style.css">
  </head>

<body>
<h2>Proxmox backup server</h2>
<li>Выяснить версию
<p><code>proxmox-backup-manager version</code>
<li>Настройка обновлений
<table><tr><td><pre>
echo "Types: deb
URIs: http://download.proxmox.com/debian/pbs
Suites: trixie
Components: pbs-no-subscription
Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg" > /etc/apt/sources.list.d/pbs-no-subscription.sources
</pre></tr></td></table>

<p><code> echo "Enabled: no" >> /etc/apt/sources.list.d/pbs-enterprise.sources</code>
<li>Устнаовка агента Proxmox VE
<p><code>apt install qemu-guest-agent -y && systemctl start qemu-guest-agent && systemctl status qemu-guest-agent && systemctl enable qemu-guest-agent</code>

<h3>Зафиксировать размер кеша</h3>
<p>Чтобы система всегда чувствовала себя стабильно и PBS не конфликтовал с ZFS за память, советую зафиксировать размер кеша.
<p>по умолчанию ZFS может забрать под свои нужды (ARC-кеш) до 50% всей оперативной памяти
<ol>
<li>Ограничиваем ARC кеш до 4 ГБ
<p><code>echo "options zfs zfs_arc_max=4294967296" > /etc/modprobe.d/zfs.conf</code>
<p>Ограничиваем ARC кеш до 6	 ГБ
<p><code>echo "options zfs zfs_arc_max=6442450944" > /etc/modprobe.d/zfs.conf</code>

<li> Обновляем конфиг загрузки
<p><code>update-initramfs -u</code>
<li>После перезагрузки проверить результат
<p><code>cat /sys/module/zfs/parameters/zfs_arc_max</code>
</ol>
<h3>мониторинг состояния ZFS ARC</h3>
<p><code>arcstat 1</code>
<p><code>arcstat -f time,hits,miss,hit%,size,c,metasz,mh% 1</code>
<table><tr><td><pre>

Столбец,	Что означает,	На что смотреть
time,		Время замера,	—
read,		Общее кол-во запросов на чтение,	Интенсивность нагрузки на хранилище.
miss,		Промахи мимо кеша,		Чем меньше, тем лучше. Если растет — данные читаются с дисков.
miss%,		Процент промахов,		Если выше 10–20% при активном бэкапе — памяти под ARC мало.
hit%,		Процент попаданий в кеш,	В идеале должен стремиться к 90%+ для повторных операций.
arcsz,		Текущий размер ARC,		Насколько кеш раздулся в данный момент.
c,		Целевой размер (Target),	"Размер, к которому ARC стремится адаптироваться."
</pre></tr></td></table>
</ol>

<h3>Datastore</h3>
<p><code>/etc/proxmox-backup/datastore.cfg</code>
<p>Если удалил diolpool
<p><code>rm -rf /mnt/datastore/diolpool</code>
<p><code>systemctl restart proxmox-backup-proxy</code>
</body>
  </html>

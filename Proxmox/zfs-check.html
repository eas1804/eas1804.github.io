<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ZFS check</title>
    <link rel="stylesheet" href="../style.css">
  </head>

<body>
<h2>Проверка ZFS</h2>
<p>Проверяем вывод команды <code>zpool status -x</code>
<p>Если он не дает <code>"all pools are healthy"</code> - высылаем отчет на e-mail.
<p>Высылаем лог файл по вторникам в любома случае
<ol>
<li>cat /root/zfs-check.sh
<table><tr><td><pre>
#!/bin/bash

# Настройки
<b><u>MAIL_TO="admin@srv.com"</u></b>

IP=$(ip -4 addr show vmbr0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
ZPOOL="rpool"
HOSTNAME=$(hostname)
LOG="/var/log/zfs.log"

date >  ${LOG}
zpool status >> ${LOG}
zpool list  >> ${LOG}

# Проверка статуса пула
STATUS=$(zpool status -x)

# Если есть проблемы (не "all pools are healthy")
if [[ "$STATUS" != "all pools are healthy" ]]; then
mutt -s "!!!PROBLEM ZFS. ip:$IP. ${HOSTNAME} " -- ${MAIL_TO} < ${LOG}
fi


# Отправить лог по вторникам
# Получаем номер дня недели: 2 — вторник (1 — понедельник, 7 — воскресенье)
DOW=$(date +%u)

if [[ "$DOW" -eq 2 ]]; then
    echo "Вторник. Высылаю отчет на ${MAIL_TO} "
mutt -s "ZFS OK. ${IP}, ${HOSTNAME}" -- "${MAIL_TO}" < "${LOG}"
else
    echo "Другой день. Отчет не высылаю"
fi
exit 0

</pre></td></tr></table>

<li>cat  /etc/systemd/system/zfs-check.service
<table><tr><td><pre>
[Unit]
Description=check ZFS status
After=network.target

[Service]
Type=oneshot
ExecStart=/root/zfs-check.sh
WorkingDirectory=/root
Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

[Install]
WantedBy=multi-user.target
</pre></td></tr></table>

<li>cat  /etc/systemd/system/zfs-check.timer
<table><tr><td><pre>
[Unit]
Description= check ZFS status
[Timer]
OnBootSec=5min
OnCalendar=*-*-* 09:03:00
[Install]
WantedBy=timers.target
</pre></td></tr></table>


 <li> Download
 <p><a href=sh/zfs-check.sh>zfs-check.sh</a>
<p><code> wget -P /root https://eas1804.github.io/Proxmox/sh/zfs-check.sh</code>
<p><code>chmod +x /root/zfs-check.sh</code>
 <p><a href=sh/zfs-check.service>zfs-check.service</a>
 <p><code> wget -P /etc/systemd/system/  https://eas1804.github.io/Proxmox/sh/zfs-check.service</code>
 <p><a href=sh/zfs-check.timer>zfs-check.timer</a> 
 <p><code>wget -P /etc/systemd/system/ https://eas1804.github.io/Proxmox/sh/zfs-check.timer</code>
<li>  systemctl 
<table><tr><td><pre>
systemctl  daemon-reload
systemctl start zfs-check.service
systemctl start zfs-check.timer
systemctl enable  zfs-check.timer
systemctl list-timers --all | grep  zfs-check.timer
</pre></td></tr></table> 
 
 </ol>

</body>
  </html>

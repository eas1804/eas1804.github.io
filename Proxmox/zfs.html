<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ZFS</title>
    <link rel="stylesheet" href="../style.css">
  </head>

<body>
<h2> ZFS</h2>
<h3>ARC</h3>
<p>ARC — это кэш чтения ZFS в оперативной памяти
<p>Рекомендации по ARC для разных объемов ОЗУ

<table border=1>
<tr>
<td>Общий объем ОЗУ</td>  <td>Рекомендуемый ARC ГБ</td> <td>Рекомендуемый ARC байт</td>
</tr>
<tr>
<td>64 ГБ</td>	<td>16 </td> <td>17179869184</td>
</tr>
<tr>
<td>128 ГБ</td>	 <td>32</td> <td>34359738368</td>
</tr>
<tr>
<td>192 ГБ</td>  <td>48</td> <td>51539607552</td>
</tr>
<tr>
<td>256 ГБ</td>	<td>80</td> <td>85899345920</td>
</tr>
</table> 
<ol>
<li>Откройте файл конфигурации:
<p><code>nano /etc/modprobe.d/zfs.conf</code>
<li>Добавьте или измените строку (например, ARC 64 ГБ):
<p><code>options zfs zfs_arc_max=68719476736 </code>
<p>Значение задается в байтах
<p>64x1024x1024x1024=68719476736
<li>Обновите initramfs и перезагрузитесь:
<p><code>update-initramfs -u -k all</code>
<p><code>proxmox-boot-tool refresh</code>
</ol>

<h3>Применить прямо сейчас (без перезагрузки)</h3>
<p><code>echo 51539607552 > /sys/module/zfs/parameters/zfs_arc_max</code>
<h3>Проверьте реальный параметр ядра</h3>
<p><code>cat /sys/module/zfs/parameters/zfs_arc_max</code>

<h3>Реальное потребление ZFS ARC</h3>
<p><code>arc_summary -s arc</code>

<h3>Диагностика производительности ZFS в реальном времени</h3>
<p>Выводит детальную статистику ввода-вывода (I/O) для конкретного пула.
<table><tr><td><pre>
zpool iostat -v rpool 5
</pre></td></tr></table> 
аналог для ext4
<table><tr><td><pre>
apt install sysstat
iostat -xz 5
</pre></td></tr></table> 
 
 
 <h3>Мониторинг ARC (Adaptive Replacement Cache) — оперативного кэша ZFS в оперативной памяти</h3>
<p><code>arcstat  1</code>
<p><code>arcstat -f miss,size,dmh% 1</code>

<p>Misses (промахи). Это количество раз в секунду, когда ZFS не нашла нужные данные в оперативной памяти и была вынуждена пойти за ними на физические диски.
<p>ddh% (Data Demand Hit %) — Это ваш основной показатель. Он показывает, какой процент данных, которые запросили приложения (1С, SQL), был найден в кэше.
<p>Например, 65.5% означает, что за оставшимися 34.5% данных ZFS пошла на диски. Должен стремиться к 100%
<p>dmh% (Data Metadata Hit %) — Показывает, сколько метаданных (информация о структуре файлов, правах и т.д.) найдено в кэше. Обычно он всегда близок к 100%.
<p>size - кеш
<table><tr><td><pre>
  arcstat -f time,hits,miss,hit%,size,c,metasz,mh% 1
</pre></td></tr></table> 

<hr>
 <h3>Тюнинг для Proxmox Backup Server (PBS)</h3>
 <p>Включаем сжатие lz4 (снижает нагрузку на медленные диски за счет CPU)
<p><code>zfs set compression=lz4 pbs-data</code>

<p>Отключаем лишние операции записи метаданных
<p><code>zfs set atime=off pbs-data</code>

<p>Ограничиваем размер блока (PBS по умолчанию пишет чанками, 128k — ок)
<p><code>zfs set recordsize=128k pbs-data</code>
 </ol>

</body>
  </html>

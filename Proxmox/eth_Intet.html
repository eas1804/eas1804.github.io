<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Если падает сеть</title>
    <link rel="stylesheet" href="../style.css">
  </head>

<body>

<h2>Проблема с сетевыми картами Intel i218/i219</h2>
<h3>Диагностика</h3>
<p><code>dmesg -T | grep -i "net"</code>

<p><code>journalctl --since "2 hours ago" | grep -iE "eth|eno|enp|vmbr|bridge|error"</code>

<h3> Если падает сеть: </h3>
<ol>
<li> Выяснить, это Intel i218/i219
<p><code>lspci | grep -i eth |grep Intel | grep 218</code>
<p><code>lspci | grep -i eth |grep Intel | grep 219</code>
<li> Если Intel i218/i219, отключить tso, gso
<p>вместо eno1 - указать свою сетевую карту
<p><code>/usr/sbin/ethtool -K  <b>eno1</b> tso off gso off</code>
<p>по максисмуму от ИИ
<p><code>ethtool -K <b>eno1</b> tx off rx off sg off tso off gso off gro off</code>



<li> для автоматизации, добавить это в файл <p><code>/etc/network/interfaces </code>	
<table><tr><td><pre>
auto vmbr0
iface vmbr0 inet static
        address 94.130.222.29/26
        gateway 94.130.222.1
        bridge-ports eno1
        bridge-stp off
        bridge-fd 0
<b>        post-up /usr/sbin/ethtool -K  eno1 tso off gso off</b>
</pre></td></td></table>
<li>Проверить состояние
 <p><code>ethtool -k eno1 | grep tcp-segmentation-offload</code>
 <p><code>ethtool -k eno1 | grep generic-segmentation-offload</code>

</ol>
<a href=https://docs.hetzner.com/robot/dedicated-server/troubleshooting/performance-intel-i218-nic/>link</a>
<h3>Вывод информации о текущей конфигурации сетевых мостов в Linux.</h3>
<p><code>brctl show</code>
<p><code>ip link show type bridge</code>
<p> или более детально
<p><code>ip addr show master vmbr0</code>
<h3>Показывает статистику и состояние здоровья  соединени</h3>
<p><code>ip -s link show</code>
<p><code>ip -s link show enp5s0</code>
<p>Следить  в реальном времени
<p><code>watch -n 1 ip -s link show enp5s0</code>

</body>
  </html>

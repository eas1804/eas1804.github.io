<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MikroTik. LAN vlan</title>
    <link rel="stylesheet" href="../../style.css">
  </head>

<body>
<h2>Шаг 3. LAN vlan</h2>
<p> Дано: <b>Acsess ports</b> - подключекние к конечным устройствам: ether2,ether3,ether4
<p> Сеть corp  192.168.33.0/24, VLAN 33, ether2,ether3
<p> Сеть guest 192.168.202.0/24, VLAN 202, ether4
<p> <b>Trunk port</b> - подключение к соседнему коммутатору: <b>ether5</b>
<p> !!! Подключаемся через интерфейс, который не входит во VLAN
<ol>
<li>Создаем bridge для vlan с именем <b>bridge_vlans</b> и vlan-filtering
<p><code>/interface/ bridge/add name=bridge_vlans vlan-filtering=yes</p></code>

<li>Создать VLAN интерфейс
<p>Создадим VLAN 33 интерфейс c именем bridge_vlans.<b>corp</b> в bridge_vlans
<p><code>/interface vlan add interface=bridge_vlans name=bridge_vlans.corp vlan-id=33</p></code>
<p>Создадим VLAN 202 интерфейс c именем bridge_vlans.<b>guest</b> в bridge_vlans
<p><code>/interface vlan add interface=bridge_vlans name=bridge_vlans.guest vlan-id=202</p></code>

<li>Настроить порт для VLAN
<p>Назначаем физическом портам ether2,ether3 метку VLAN номер 33
<p>Назначаем физическом портам ether4 метку VLAN номер 202
<p>Но не трогаем тот порт через который подключены в данный момент 
<p>И добавляем этот физический порт в мост bridge_vlans. Эти порты не должны входить в другие мосты


<table><tr><td><pre>
/interface bridge  port
add bridge=bridge_vlans interface=ether2 pvid=33
add bridge=bridge_vlans interface=ether3 pvid=33
add bridge=bridge_vlans interface=ether4 pvid=202
add bridge=bridge_vlans interface=ether5 pvid=1


add bridge=bridge_vlans interface=wlan1 pvid=33
add bridge=bridge_vlans interface=wlan2 pvid=33
</pre></td></tr></table>
<li>Определим тегированные и нетегированне порты
<p>Определяем ether2,ether3,ether4,wlan1,wlan2 как нетегированные порты
<p>А bridge_vlans, <b>ether5</b> – тегированный

<p><code>/interface bridge vlan add bridge=bridge_vlans tagged=bridge_vlans,ether5 untagged=ether2,ether3,wlan1,wlan2 vlan-ids=33</p></code>
<p><code>/interface bridge vlan add bridge=bridge_vlans tagged=bridge_vlans,ether5 untagged=ether4 vlan-ids=202</p></code>

<p>То есть, если на bridge_vlans придет кадр, помеченный  vlan 33 или 202, он его примет. Трафик из любого другого VLAN будет отброшен

<li>Назначить IP адрес
<p>Для корпоративной сети
<p><code>/ip address add address=192.168.33.1/24 interface=bridge_vlans.corp network=192.168.33.0</p></code>
<p>Для гостевой сети
<p><code>/ip address add address=192.168.202.1/24 interface=bridge_vlans.guest network=192.168.202.0</p></code>

<li>Создаем pool для DHCP 
<table><tr><td><pre>
/ip/ pool/ 
add name="pool_corp" ranges="192.168.33.2-192.168.33.202"
add name="pool_guest" ranges="192.168.202.2-192.168.202.250"
</pre></td></tr></table>
<li>Создаем DHCP server
<table><tr><td><pre>
/ip dhcp-server/
add  address-pool=pool_corp  disabled=no  interface=bridge_vlans.corp name=dhcp33
add  address-pool=pool_guest  disabled=no  interface=bridge_vlans.guest name=dhcp202
</pre></td></tr></table>
<table><tr><td><pre>
/ip dhcp-server network
add address=192.168.33.0/24 dns-server=8.8.8.8,208.67.222.222 gateway=192.168.33.1
add address=192.168.202.0/24 dns-server=8.8.8.8,208.67.222.222 gateway=192.168.202.1
</pre></td></tr></table>
<li>Перевести порт с которого настраивал устройство в нужный VLAN
<table><tr><td><pre>
/interface bridge  port
add bridge=bridge_vlans interface=ether7 pvid=202
/interface bridge vlan add bridge=bridge_vlans untagged=ether7
</pre></td></tr></table>

<hr>
<h3>Задача. Перенести ether5 в другой VLAN</h3>
<p>Шаг 1. Перенести порт из текущего моста в мост с vlan
<p>bridge_vlans -> bridge_vlans
 <p><img src=vlan1.png>
 <p><img src=vlan2.png>
<p>Шаг 2. Укзазать, что ether5 - нетегиованный
 <p><img src=vlan3.png>
<hr>
<h2> На свиче, который подключен к маршрутизатору (Trunk port) </h2>
<p>транковым  портом будет ether 1
<p>ehter2 и ehter3 будут в VLAN 33
<p>ehter4 иehter5 будут в VLAN 202


<ol>
<li>Создание моста с VLAN-фильтрацией
<table><tr><td><pre>
/interface bridge add name=bridge_vlans vlan-filtering=yes
</pre></td></tr></table>
<li>Настройка VLAN на мосту
<table><tr><td><pre>
/interface vlan
add interface=bridge_vlans name=<b>corp</b> vlan-id=<b>33</b> 
add interface=bridge_vlans name=<b>guest</b> vlan-id=<b>202</b>
</pre></td></tr></table>
<li>Назначение портов в мост
<table><tr><td><pre>
/interface bridge port 
add bridge=bridge_vlans interface=ether1 
add bridge=bridge_vlans interface=ether2 pvid=33 
add bridge=bridge_vlans interface=ether3 pvid=33 
add bridge=bridge_vlans interface=ether4 pvid=202 
add bridge=bridge_vlans interface=ether5 pvid=202
</pre></td></tr></table>
<li>Настройка VLAN: ether1 как транковый порт, остальные как access-порты
<table><tr><td><pre>
/interface bridge vlan 
add bridge=bridge_vlans tagged=bridge_vlans,ether1 untagged=ether2,ether3 vlan-ids=33 
add bridge=bridge_vlans tagged=bridge_vlans,ether1 untagged=ether4,ether5 vlan-ids=202
</pre></td></tr></table>
</ol>
</pre></td></tr></table>
</body>
  </html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Restic. check</title>
    <link rel="stylesheet" href="../style.css">
  </head>
<body>

<h2>Проверка. Был ли создан сегодня snapshot</h2>
<p>Если сегдня не был создан snapshot - высылаю уведомление в телеграмм.
<p> Создать файл .env
<table><tr><td><pre>
BOT_TOKEN=18045447450203:AAGEjU7HKEEGle1Zv2an5sVF49QxNxhw03w
CHAT_ID=33109821804
</pre></td></tr></table>

<p>Высылаю лог файл по вторинкам в любом случае

<h3>задать параметры:</h3>

<ol>
<li>EMAIL_REPORT
<li>REMOTE_HOST
<li>REMOTE_USER
<li>REMOTE_PATH
<li>SSH_KEY_PATH
<li>PASSWORD_FILE
</oL>


<h3>Скрипт по SSH</h3>
<table><tr><td><pre>
#!/bin/bash

# email для отчетов
EMAIL_REPORT="report@domen.com"

# Параметры локального репозитория

REMOTE_HOST=backup12345.backup.1cloudlab.com
REMOTE_USER=backup12345
REMOTE_PATH=/backup/restic/company/
SSH_KEY_PATH=/root/.ssh/colocall.key
PASSWORD_FILE="/root/restic-password.txt"

# Загрузка переменных из .env для отчета в телегшрам
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/.env"

# IP для уведомлений
IP_local=$( ip -4 -br a | grep UP |  awk '{print $3}')
IP_global=$(curl -s ifconfig.me)

LOG_FILE=/var/log/unac_restic.log

#Получить  тукущцю дату
TODAY=$(date +%F) # формат YYYY-MM-DD
echo TODAY is $TODAY >$LOG_FILE

# лог файл
exec > >(tee -a $LOG_FILE) 2>&1

echo ==================== "$REMOTE_HOST"=====================
# 1. отобразить всех snapshots c тегом --tag
<u>TAG=1c</u>
RESTIC_PASSWORD_FILE="$PASSWORD_FILE" restic -r sftp:"$REMOTE_USER"@"$REMOTE_HOST":"$REMOTE_PATH" \
-o "sftp.command=ssh -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no "$REMOTE_USER"@"$REMOTE_HOST" -s sftp" \
snapshots --tag=$TAG

# 2. отобразить всех snapshots c тегом --tag
<u>TAG=Glavbuh_Desktop</u>
RESTIC_PASSWORD_FILE="$PASSWORD_FILE" restic -r sftp:"$REMOTE_USER"@"$REMOTE_HOST":"$REMOTE_PATH" \
-o "sftp.command=ssh -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no "$REMOTE_USER"@"$REMOTE_HOST" -s sftp" \
snapshots --tag=$TAG

echo ====================  "$TODAY" ===========================
# отобразить snapshots
RESTIC_PASSWORD_FILE="$PASSWORD_FILE" restic -r sftp:"$REMOTE_USER"@"$REMOTE_HOST":"$REMOTE_PATH" \
-o "sftp.command=ssh -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no "$REMOTE_USER"@"$REMOTE_HOST" -s sftp" \
snapshots  | grep "$TODAY"

# Проверка наличия снапшота за сегодня
echo "=== Проверка наличия снапшота за $TODAY ==="
SNAPSHOT_TODAY=$(RESTIC_PASSWORD_FILE="$PASSWORD_FILE" restic -r sftp:"$REMOTE_USER"@"$REMOTE_HOST":"$REMOTE_PATH" \
-o "sftp.command=ssh -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no "$REMOTE_USER"@"$REMOTE_HOST" -s sftp" \
snapshots  | grep "$TODAY")

if [[ -n "$SNAPSHOT_TODAY" ]]; then
    echo "Результат: ОК — найден снапшот за $TODAY"
else
    echo "Результат: ПРОБЛЕМА — нет снапшота за $TODAY"
    MESSAGE="⚠️ Restic: сегодня ($TODAY) не создан снапшот в репозитории $REPO
LAN: $IP_local
WAN: $IP_global
$0
"
    curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d text="$MESSAGE"
fi

#Отобразить статистику по snapshot
RESTIC_PASSWORD_FILE="$PASSWORD_FILE" restic -r sftp:"$REMOTE_USER"@"$REMOTE_HOST":"$REMOTE_PATH" \
-o "sftp.command=ssh -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no "$REMOTE_USER"@"$REMOTE_HOST" -s sftp" \
stats
#Отобразить статистику по snapshot (сколько реально занимают данные в хранилище)
RESTIC_PASSWORD_FILE="$PASSWORD_FILE" restic -r sftp:"$REMOTE_USER"@"$REMOTE_HOST":"$REMOTE_PATH" \
-o "sftp.command=ssh -i "$SSH_KEY_PATH" -o StrictHostKeyChecking=no "$REMOTE_USER"@"$REMOTE_HOST" -s sftp" \
stats --mode  raw-data


# Отправить лог по вторникам
# Получаем номер дня недели: 2 — вторник (1 — понедельник, 7 — воскресенье)
DOW=$(date +%u)

if [[ "$DOW" -eq 2 ]]; then
    echo "Вторник. Высылаю отчет на $EMAIL_REPORT "
mutt -s "Metcon colocall  Restic  Log. IP 172.16.16.2, WAN 195.201.9.226" -- "$EMAIL_REPORT" < "$LOG_FILE"
else
    echo "Сегодня не вторник. Отчет не высылаю"
fi
exit 0
</pre></td></tr></table>

</body>

